---
title: "Untitled"
author: "RQ"
date: "05/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("dplyr")
library("purrr")
```

This RMarkdown document explores the rendering of multiple dashboards.

```{r render}
rmarkdown::render(
  input = "apt_dashboard_01.Rmd"
  # , params = list(seg = "Focus1", grp = "Core", per = "Weekly")
  , output_file = "test_01.html"
  #, output_dir = "/myfiles-dir"
)
```


In order to produce a series of dashboards, the render call needs to be looped over the set of airports.
For this we 

* create an iterator, 
* pass the airport location identifier as a parameter to the template dashboard pages, and
* render the output to a specific file name (apt.html).

```{r}
apts   <- c("EGLL", "EDDF")
tfc_df <- iris

apts %>% 
  purrr::walk(
    .f=~rmarkdown::render(
      input = "apt_dashboard_01.Rmd"
      , params = list(apt = ., tfc = tfc_df)  #paste0(.))
      #, output_dir = "/boards"
      , output_file = paste0(.,".html")
      )
    )
```

wrap this into function and then load "payload data", filter it for apt and provide it to template with parameter
df <- readxl::read_excel(tfc, sheet = "DATA")

```{r}
apts   <- c("EGLL", "EDDF", "EIDW")


## ------------ READ DATA TABLES FROM DOWNLOAD POINT ------------------

tfc_df <- readxl::read_excel("Airport_Traffic.xlsx", sheet = "DATA"
  # readxl style to force all chr # , col_types = "text" #
) %>%
  mutate(FLT_DATE = lubridate::date(FLT_DATE)) 


atfm_df <- readxl::read_excel("Airport_Arrival_ATFM_Delay.xlsx", sheet = "DATA") %>%
  mutate(FLT_DATE = lubridate::date(FLT_DATE)) 


## ------------ UTILITY FUNCTIONS -------------------------------------

##### --------- DOWNSAMPLE DATA --------------------------------

filter_df_by_apt <- function(.df, .apt){
  df <- .df %>% filter(APT_ICAO == .apt)
}


## ------------ RENDER DASHBOARDS -------------------------------------

apts %>% 
  purrr::walk(
    .f=~rmarkdown::render(
        input  = "apt_dashboard_02.Rmd"
      , params = list(apt = ., tfc = filter_df_by_apt(tfc_df, .apt = .)
                      , atfm = filter_df_by_apt(atfm_df, .apt = .))
      
      
      #, output_dir = "/boards"
      , output_file = paste0(.,".html")
      )
    )


```

geht nicht mehr

apts %>% 
  purrr::walk(
    .f=~rmarkdown::render(
      #input = "apt_dashboard_01.Rmd"
      input = "apt_dashboard_02.Rmd"
      , params = list(apt = . 
                      , tfc = filter_df_by_apt(tfc_df, .apt = .)  
      ) # end params list
                      #   #paste0(.)) .. %>% filter_df_by_apt(.apt = .)   )
      #, output_dir = "/boards"
      , output_file = paste0(.,".html")
      )
    )



                   
